{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "vnetName": {
      "type": "string",
      "defaultValue": "VNet1"
    },
    "virtualMachineScaleSets_vmscaleset_name": {
            "defaultValue": "vmscaleset",
            "type": "String"
        },
        "loadBalancers_vmscalesetLb_name": {
            "defaultValue": "vmscalesetLb",
            "type": "String"
        },
        "publicIPAddresses_ip01_name": {
            "defaultValue": "ip01",
            "type": "String"
        },
        
    "vnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.0.0/16"
    },
    "subnet1Prefix": {
      "type": "string",
      "defaultValue": "10.0.0.0/24"
    },
    "subnet1Name": {
      "type": "string",
      "defaultValue": "Subnet1"
    },
    "subnet2Prefix": {
      "type": "string",
      "defaultValue": "10.0.1.0/24"
    },
    "subnet2Name": {
      "type": "string",
      "defaultValue": "Subnet2"
    },
    "frontEndNSGName": {
      "type": "string",
      "defaultValue": "NSG1"
    },
    "backEndNSGName": {
      "type": "string",
      "defaultValue": "NSG2"
    }
  },
  "variables": {
    "apiVersion": "2015-06-15"
  },
  "resources": [
    {
      "apiVersion": "[variables('apiVersion')]",
      "type": "Microsoft.Network/virtualNetworks",
      "name": "[parameters('vnetName')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('Microsoft.Network/networkSecurityGroups/', parameters('frontEndNSGName'))]",
        "[concat('Microsoft.Network/networkSecurityGroups/', parameters('backEndNSGName'))]"
      ],
      "properties": {
        "addressSpace": {
          "addressPrefixes": [
            "[parameters('vnetAddressPrefix')]"
          ]
        },
        
        "subnets": [
          {
            "name": "[parameters('subnet1Name')]",
            "properties": {
              "addressPrefix": "10.0.2.0/24",
              "networkSecurityGroup": {
      "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('frontEndNSGName'))]"
      }
            }
          },
          {
            "name": "[parameters('subnet2Name')]",
            "properties": {
              "addressPrefix": "[parameters('subnet2Prefix')]"
            }
          }
        ],

      }
    },
    {
            "comments": "Generalized from resource: '/subscriptions/3d68a81a-c96c-4709-bad5-e438ad1e2890/resourceGroups/RGR/providers/Microsoft.Compute/virtualMachineScaleSets/vmscaleset'.",
            "type": "Microsoft.Compute/virtualMachineScaleSets",
            "sku": {
                "name": "Standard_D1_v2",
                "tier": "Standard",
                "capacity": 3
            },
            "name": "[parameters('virtualMachineScaleSets_vmscaleset_name')]",
            "apiVersion": "2016-04-30-preview",
            "location": "westus",
            "scale": null,
            "properties": {
                "singlePlacementGroup": true,
                "upgradePolicy": {
                    "mode": "Manual"
                },
                "virtualMachineProfile": {
                    "osProfile": {
                        "computerNamePrefix": "vmscalese",
                        "adminUsername": "admiin",
                        "windowsConfiguration": {
                            "provisionVMAgent": true,
                            "enableAutomaticUpdates": true
                        },
                        "secrets": []
                    },
                    "storageProfile": {
                        "osDisk": {
                            "createOption": "FromImage",
                            "caching": "ReadWrite",
                            "managedDisk": {
                                "storageAccountType": "Standard_LRS"
                            }
                        },
                        "imageReference": {
                            "publisher": "MicrosoftWindowsServer",
                            "offer": "WindowsServer",
                            "sku": "2016-Datacenter",
                            "version": "latest"
                        }
                    },
                    "networkProfile": {
                        "networkInterfaceConfigurations": [
                            {
                                "name": "[concat(parameters('virtualMachineScaleSets_vmscaleset_name'),'Nic')]",
                                "properties": {
                                    "primary": true,
                                    "ipConfigurations": [
                                        {
                                            "name": "[concat(parameters('virtualMachineScaleSets_vmscaleset_name'),'IpConfig')]",
                                            "properties": {
                                                "subnet": {
                                                    "id": "[concat(resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName')), '/subnets/default')]"
                                                },
                                                "loadBalancerBackendAddressPools": [
                                                    {
                                                        "id": "[concat(resourceId('Microsoft.Network/loadBalancers', parameters('loadBalancers_vmscalesetLb_name')), '/backendAddressPools/bepool')]"
                                                    }
                                                ],
                                                "loadBalancerInboundNatPools": [
                                                    {
                                                        "id": "[concat(resourceId('Microsoft.Network/loadBalancers', parameters('loadBalancers_vmscalesetLb_name')), '/inboundNatPools/natpool')]"
                                                    }
                                                ]
                                            }
                                        }
                                    ]
                                }
                            }
                        ]
                    }
                },
                "overprovision": true
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]",
                "[resourceId('Microsoft.Network/loadBalancers', parameters('loadBalancers_vmscalesetLb_name'))]"
            ]
        },
        {
            "comments": "Generalized from resource: '/subscriptions/3d68a81a-c96c-4709-bad5-e438ad1e2890/resourceGroups/RGR/providers/Microsoft.Network/loadBalancers/vmscalesetLb'.",
            "type": "Microsoft.Network/loadBalancers",
            "name": "[parameters('loadBalancers_vmscalesetLb_name')]",
            "apiVersion": "2017-03-01",
            "location": "westus",
            "scale": null,
            "properties": {
                "frontendIPConfigurations": [
                    {
                        "name": "LoadBalancerFrontEnd",
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('publicIPAddresses_ip01_name'))]"
                            }
                        }
                    }
                ],
                "backendAddressPools": [
                    {
                        "name": "bepool"
                    }
                ],
                "loadBalancingRules": [],
                "probes": [],
                "inboundNatRules": [
                    {
                        "name": "natpool.0",
                        "properties": {
                            "frontendIPConfiguration": {
                                "id": "[parameters('loadBalancers_vmscalesetLb_id')]"
                            },
                            "frontendPort": 50000,
                            "backendPort": 3389,
                            "protocol": "Tcp"
                        }
                    },
                    {
                        "name": "natpool.1",
                        "properties": {
                            "frontendIPConfiguration": {
                                "id": "[parameters('loadBalancers_vmscalesetLb_id_1')]"
                            },
                            "frontendPort": 50001,
                            "backendPort": 3389,
                            "protocol": "Tcp"
                        }
                    },
                    {
                        "name": "natpool.2",
                        "properties": {
                            "frontendIPConfiguration": {
                                "id": "[parameters('loadBalancers_vmscalesetLb_id_2')]"
                            },
                            "frontendPort": 50002,
                            "backendPort": 3389,
                            "protocol": "Tcp"
                        }
                    },
                    {
                        "name": "natpool.3",
                        "properties": {
                            "frontendIPConfiguration": {
                                "id": "[parameters('loadBalancers_vmscalesetLb_id_3')]"
                            },
                            "frontendPort": 50003,
                            "backendPort": 3389,
                            "protocol": "Tcp"
                        }
                    },
                    {
                        "name": "natpool.4",
                        "properties": {
                            "frontendIPConfiguration": {
                                "id": "[parameters('loadBalancers_vmscalesetLb_id_4')]"
                            },
                            "frontendPort": 50004,
                            "backendPort": 3389,
                            "protocol": "Tcp"
                        }
                    },
                    {
                        "name": "natpool.5",
                        "properties": {
                            "frontendIPConfiguration": {
                                "id": "[parameters('loadBalancers_vmscalesetLb_id_5')]"
                            },
                            "frontendPort": 50005,
                            "backendPort": 3389,
                            "protocol": "Tcp"
                        }
                    },
                    {
                        "name": "natpool.6",
                        "properties": {
                            "frontendIPConfiguration": {
                                "id": "[parameters('loadBalancers_vmscalesetLb_id_6')]"
                            },
                            "frontendPort": 50006,
                            "backendPort": 3389,
                            "protocol": "Tcp"
                        }
                    }
                ],
                "outboundNatRules": [],
                "inboundNatPools": [
                    {
                        "name": "natpool",
                        "properties": {
                            "frontendPortRangeStart": 50000,
                            "frontendPortRangeEnd": 50119,
                            "backendPort": 3389,
                            "protocol": "Tcp",
                            "frontendIPConfiguration": {
                                "id": "[parameters('loadBalancers_vmscalesetLb_id_7')]"
                            }
                        }
                    }
                ]
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', parameters('publicIPAddresses_ip01_name'))]"
            ]
        },
        {
            "comments": "Generalized from resource: '/subscriptions/3d68a81a-c96c-4709-bad5-e438ad1e2890/resourceGroups/RGR/providers/Microsoft.Network/publicIPAddresses/ip01'.",
            "type": "Microsoft.Network/publicIPAddresses",
            "name": "[parameters('publicIPAddresses_ip01_name')]",
            "apiVersion": "2017-03-01",
            "location": "westus",
            "scale": null,
            "properties": {
                "publicIPAllocationMethod": "Dynamic",
                "idleTimeoutInMinutes": 4,
                "dnsSettings": {
                    "domainNameLabel": "dragonwizard"
                }
            },
            "dependsOn": []
        },
    {
      "apiVersion": "[variables('apiVersion')]",
"type": "Microsoft.Network/networkSecurityGroups",
"name": "[parameters('frontEndNSGName')]",
"location": "[resourceGroup().location]",
"properties": {
  "securityRules": [
    {
      "name": "rdp-rule",
      "properties": {
        "description": "Allow RDP",
        "protocol": "Tcp",
        "sourcePortRange": "*",
        "destinationPortRange": "3389",
        "sourceAddressPrefix": "Internet",
        "destinationAddressPrefix": "*",
        "access": "Allow",
        "priority": 100,
        "direction": "Inbound"
      }
    },
    {
      "name": "web-rule",
      "properties": {
        "description": "Allow WEB",
        "protocol": "Tcp",
        "sourcePortRange": "*",
        "destinationPortRange": "80",
        "sourceAddressPrefix": "Internet",
        "destinationAddressPrefix": "*",
        "access": "Allow",
        "priority": 101,
        "direction": "Inbound"
      }
    }
  ]
  }
  },
  {
      "apiVersion": "2015-06-15",
      "type": "Microsoft.Network/networkSecurityGroups",
      "name": "[parameters('backEndNSGName')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "displayName": "NSG - Remote Access"
      },
      "properties": {
        "securityRules": [
          {
            "name": "allow-frontend",
            "properties": {
              "description": "Allow FE Subnet",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "1433",
              "sourceAddressPrefix": "[parameters('frontEndSubnetPrefix')]",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 100,
              "direction": "Inbound"
            }
          },
          {
            "name": "block-internet",
            "properties": {
              "description": "Block Internet",
              "protocol": "*",
              "sourcePortRange": "*",
              "destinationPortRange": "*",
              "sourceAddressPrefix": "*",
              "destinationAddressPrefix": "Internet",
              "access": "Deny",
              "priority": 200,
              "direction": "Outbound"
            }
          }

        ]
      }
    }
  ]
}
